prompt = f"""
You are an assistant helping Pascual understand its clients' past behavior.

You will receive structured data for one client. Use this data to answer questions such as:
- What is the city or channel of the client?
- What was the yearly income, volume, median ticket, or efficiency?
- How many contacts or visits they had?

üü¢ Only use the data provided.
‚ùå Do not suggest changes or make assumptions.
‚ùå If a field is missing, say "That information is not available."

Client data:
{context}


import streamlit as st
import os
import pandas as pd
import re
from langchain_google_genai import ChatGoogleGenerativeAI

# --- Load API Key ---
GOOGLE_API_KEY = st.secrets.get("GOOGLE_API_KEY") or os.getenv("GOOGLE_API_KEY")
if not GOOGLE_API_KEY:
    st.error("‚ùå Google API key not found. Add it to .streamlit/secrets.toml or .env.")
    st.stop()
os.environ["GOOGLE_API_KEY"] = GOOGLE_API_KEY

# --- UI Setup ---
st.image("assets/LOGO-CALIDAD-PASCUAL.png", width=200)
st.title("üì¶ Pascual GPT - Client Insights")
st.markdown("---")

# --- Load CSV and prepare client lookup ---
@st.cache_data
def load_client_data(csv_path):
    df = pd.read_csv(csv_path)
    df = df.astype(str)  # Make sure all data is text for prompting
    return df.set_index("client_id").to_dict(orient="index")

csv_path = "yearly_df.csv"  # Replace with your optimized table path when ready
client_lookup = load_client_data(csv_path)

# --- LLM Setup ---
llm = ChatGoogleGenerativeAI(model="gemini-2.0-flash", temperature=0)

# --- Explanation function ---
def explain_client_data(client_id: str, question: str) -> str:
    client_data = client_lookup.get(client_id)

    if not client_data:
        return f"‚ùå Client {client_id} not found."

    # Format the row into natural language context
    context = "\n".join([f"{key}: {value}" for key, value in client_data.items()])

    # Prompt: descriptive only, no suggestions
    prompt = f"""
You are a data assistant helping Pascual analyze changes made to client visit frequencies.

Your job is to explain what changed, using ONLY the context provided below.

‚úÖ Focus on:
- The client's original frequency and number of contacts.
- The new frequency and number of contacts suggested by the model.
- Changes in efficiency and total cost.
- Estimated savings (difference between old and new total cost).
- Estimate how many months it would take to recover the savings, using monthly cost differences.
- Do not mention or guess volume, city, or other unrelated values unless included in the context.

‚ö†Ô∏è Very Important:
- DO NOT invent or assume any values.
- DO NOT generalize from examples.
- Only use exact values that appear in the context.
- If a required field is missing, say: "This information is not available."

üìå Here's a real example of how to answer:
The client 653025 had a frequency of 3.0 and 4 contacts. The new model suggests 2.0 and 3 contacts. This saves 180‚Ç¨, improves efficiency, and would take 2 months to recover the savings.

---

Context:
{context}

Question:
{question}
"""

    return llm.invoke(prompt).content

# --- Streamlit Input ---
st.markdown("### üí¨ Ask a question about a client")
user_input = st.text_input("Example: What is the yearly income of client 100229632?")

if st.button("Run Query"):
    if user_input:
        with st.spinner("üîç Thinking..."):
            match = re.search(r"([0-9]{6,})", user_input)
            if match:
                client_id = match.group(1)
                response = explain_client_data(client_id, user_input)
                st.markdown("### ‚úÖ Answer:")
                st.write(response)
            else:
                st.warning("Please include a valid client ID in your question.")
    else:
        st.warning("Please enter a question.")